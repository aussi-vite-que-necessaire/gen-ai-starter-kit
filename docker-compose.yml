services:
  # --- BACKEND (API) ---
  api:
    image: ${IMAGE_NAME_API}
    restart: always
    networks:
      - web_network
      - default
    environment:
      - NODE_ENV=${ENV_TYPE}
      - PORT=3000
      # DB & Cache
      - POSTGRES_HOST=db
      - POSTGRES_USER=app_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=mydb
      - DATABASE_URL=postgresql://app_user:${DB_PASSWORD}@db:5432/mydb
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Mail
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      # URLs (Pour CORS)
      - FRONTEND_URL=https://${DOMAIN_NAME_WEB}
    labels:
      - "traefik.enable=true"
      # Router API : api.domaine.com
      - "traefik.http.routers.${SERVICE_NAME}-api.rule=Host(`${DOMAIN_NAME_API}`)"
      - "traefik.http.routers.${SERVICE_NAME}-api.entrypoints=websecure"
      - "traefik.http.routers.${SERVICE_NAME}-api.tls.certresolver=myresolver"
      - "traefik.http.services.${SERVICE_NAME}-api.loadbalancer.server.port=3000"
      # Rate Limit API
      - "traefik.http.middlewares.limit-api.ratelimit.average=100"
      - "traefik.http.middlewares.limit-api.ratelimit.burst=50"
      - "traefik.http.routers.${SERVICE_NAME}-api.middlewares=limit-api"

  # --- FRONTEND (WEB) ---
  web:
    image: ${IMAGE_NAME_WEB}
    restart: always
    networks:
      - web_network
    labels:
      - "traefik.enable=true"
      # Router Web : domaine.com
      - "traefik.http.routers.${SERVICE_NAME}-web.rule=Host(`${DOMAIN_NAME_WEB}`)"
      - "traefik.http.routers.${SERVICE_NAME}-web.entrypoints=websecure"
      - "traefik.http.routers.${SERVICE_NAME}-web.tls.certresolver=myresolver"
      - "traefik.http.services.${SERVICE_NAME}-web.loadbalancer.server.port=80"

  # --- WORKER (Optionnel pour plus tard / BullMQ) ---
  # worker:
  #   image: ${IMAGE_NAME_API}
  #   command: ["node", "src/worker.js"]
  #   networks:
  #     - default
  #   environment: ...

  # --- INFRA (Reste identique) ---
  db:
    image: postgres:15-alpine
    restart: always
    networks:
      - default
    environment:
      - POSTGRES_USER=app_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=mydb
    volumes:
      - db_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - default

  db-backup:
    image: prodrigestivill/postgres-backup-local
    restart: always
    networks:
      - default
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB=mydb
      - POSTGRES_USER=app_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - SCHEDULE=@daily
      - BACKUP_KEEP_DAYS=7
    volumes:
      - ./backups:/backups

  mailpit:
    image: axllent/mailpit
    restart: always
    networks:
      - web_network
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${SERVICE_NAME}-mail.rule=Host(`emails.${DOMAIN_NAME_WEB}`)" # emails.domaine.com
      - "traefik.http.routers.${SERVICE_NAME}-mail.entrypoints=websecure"
      - "traefik.http.routers.${SERVICE_NAME}-mail.tls.certresolver=myresolver"
      - "traefik.http.services.${SERVICE_NAME}-mail.loadbalancer.server.port=8025"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$mTp02pz/$$JgD44iCfTvV5g6ORuzrJJ."
      - "traefik.http.routers.${SERVICE_NAME}-mail.middlewares=auth"

volumes:
  db_data:

networks:
  web_network:
    external: true
