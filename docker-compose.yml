services:
  # --- BACKEND (API) ---
  api:
    image: ${IMAGE_NAME_API}
    restart: always
    networks:
      - web_network
      - default
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=3000
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - N8N_URL=${N8N_URL}
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET}
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
    labels:
      - "traefik.enable=true"
      # Router API
      - "traefik.http.routers.${PROJECT_NAME}-api.rule=Host(`${DOMAIN_NAME_API}`)"
      - "traefik.http.routers.${PROJECT_NAME}-api.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-api.tls.certresolver=myresolver"
      - "traefik.http.services.${PROJECT_NAME}-api.loadbalancer.server.port=3000"
      # Rate Limit
      - "traefik.http.middlewares.limit-api.ratelimit.average=100"
      - "traefik.http.middlewares.limit-api.ratelimit.burst=50"
      - "traefik.http.routers.${PROJECT_NAME}-api.middlewares=limit-api"

  # --- FRONTEND (WEB) ---
  web:
    image: ${IMAGE_NAME_WEB}
    restart: always
    networks:
      - web_network
    labels:
      - "traefik.enable=true"
      # Router Web
      - "traefik.http.routers.${PROJECT_NAME}-web.rule=Host(`${DOMAIN_NAME_WEB}`)"
      - "traefik.http.routers.${PROJECT_NAME}-web.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-web.tls.certresolver=myresolver"
      - "traefik.http.services.${PROJECT_NAME}-web.loadbalancer.server.port=80"

  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - default

  mailpit:
    image: axllent/mailpit
    restart: always
    networks:
      - web_network
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME}-mail.rule=Host(`emails.${DOMAIN_NAME_WEB}`)"
      - "traefik.http.routers.${PROJECT_NAME}-mail.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-mail.tls.certresolver=myresolver"
      - "traefik.http.services.${PROJECT_NAME}-mail.loadbalancer.server.port=8025"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$mTp02pz/$$JgD44iCfTvV5g6ORuzrJJ."
      - "traefik.http.routers.${PROJECT_NAME}-mail.middlewares=auth"

  # --- N8N ---
  n8n:
    # âœ… On utilise l'image officielle (plus besoin de build custom)
    image: n8nio/n8n:latest
    restart: always
    environment:
      - N8N_HOST=n8n
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      # URLs & Secrets
      - WEBHOOK_URL=${N8N_URL}
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET}
      - GENAI_API_URL=http://api:3000
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_BASIC_AUTH_ACTIVE=false

      # Connexion DB (Variables injectÃ©es par le deploy.yml)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres-central
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB_N8N}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASSWORD}

    volumes:
      # Persistance des donnÃ©es N8N
      - n8n_data:/home/node/.n8n

      # ðŸ‘‡ C'EST ICI QUE LA MAGIE OPÃˆRE ðŸ‘‡
      # On mappe ton dossier local (copiÃ© par scp) directement dans le dossier custom de N8N
      - ./apps/automation/custom-node:/home/node/.n8n/custom/n8n-nodes-genai-app

    depends_on:
      - redis
    networks:
      - default
      - web_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME}-n8n.rule=Host(`${DOMAIN_NAME_N8N}`)"
      - "traefik.http.routers.${PROJECT_NAME}-n8n.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-n8n.tls.certresolver=myresolver"
      - "traefik.http.services.${PROJECT_NAME}-n8n.loadbalancer.server.port=5678"

volumes:
  db_data: # (Optionnel si tu n'utilises plus la DB locale, mais garde-le au cas oÃ¹)
  n8n_data:

networks:
  web_network:
    external: true
