name: Deploy App

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Lowercase Repo Name
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # --- 1. BUILD DES IMAGES (API, WEB, N8N) ---

      - name: Build API
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: ghcr.io/${{ env.REPO_LOWER }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: ghcr.io/${{ env.REPO_LOWER }}/web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # üëá BUILD DU N8N CUSTOM (Plus propre que le curl au runtime)
      - name: Build Custom N8N
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./apps/automation/Dockerfile
          push: true
          tags: ghcr.io/${{ env.REPO_LOWER }}/n8n-custom:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- 2. CONFIGURATION ---

      - name: Copy Config to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml,apps/automation/workflows/,apps/automation/seed/"
          target: "apps/${{ vars.PROJECT_NAME }}"

      # --- 3. D√âPLOIEMENT & PROVISIONING DB ---

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Nettoyage l√©ger des vieilles images (sans danger)
            docker image prune -f

            # --- VARIABLES ---
            # Nom des DBs bas√© sur le projet (ex: gen-ai-starter-kit_app)
            # On remplace les tirets par des underscores pour SQL si besoin, mais postgres accepte les tirets si "quoted"
            PROJECT_DB_APP="${{ vars.PROJECT_NAME }}_app"
            PROJECT_DB_N8N="${{ vars.PROJECT_NAME }}_n8n"
            # Un user d√©di√© pour ce projet
            DB_USER="${{ vars.PROJECT_NAME }}_user"

            # --- PROVISIONING POSTGRES CENTRAL ---
            # On utilise un client postgres √©ph√©m√®re pour parler au port 5432 localhost du VPS
            echo "üêò Provisioning Database on Central Postgres..."

            docker run --rm --network host \
              -e PGPASSWORD=${{ secrets.CENTRAL_DB_PASSWORD }} \
              postgres:16-alpine \
              psql -h 127.0.0.1 -U admin_postgres -d postgres -c "
                /* 1. Cr√©ation User du projet s'il n'existe pas */
                DO \$\$ BEGIN
                  IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$DB_USER') THEN
                    CREATE ROLE \"$DB_USER\" WITH LOGIN PASSWORD '${{ secrets.DB_PASSWORD }}';
                  END IF;
                END \$\$;
                
                /* 2. Cr√©ation DB App */
                SELECT 'CREATE DATABASE \"$PROJECT_DB_APP\" OWNER \"$DB_USER\"'
                WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '$PROJECT_DB_APP')\gexec
                
                /* 3. Cr√©ation DB N8N */
                SELECT 'CREATE DATABASE \"$PROJECT_DB_N8N\" OWNER \"$DB_USER\"'
                WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '$PROJECT_DB_N8N')\gexec
              "

            # --- SETUP DU PROJET ---
            cd ~/apps/${{ vars.PROJECT_NAME }}
            REPO_LOWER="${{ env.REPO_LOWER }}"

            echo "üîß G√©n√©ration .env..."
            cat <<EOF > .env
            # Images
            IMAGE_NAME_API=ghcr.io/$REPO_LOWER/api:latest
            IMAGE_NAME_WEB=ghcr.io/$REPO_LOWER/web:latest
            IMAGE_NAME_N8N=ghcr.io/$REPO_LOWER/n8n-custom:latest

            # DB Centralis√©e
            POSTGRES_USER=$DB_USER
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            POSTGRES_DB=$PROJECT_DB_APP
            POSTGRES_DB_N8N=$PROJECT_DB_N8N

            # Config App
            PROJECT_NAME=${{ vars.PROJECT_NAME }}
            NODE_ENV=production
            PORT=3000

            # URLs
            DOMAIN_NAME_WEB=${{ vars.MAIN_DOMAIN }}
            DOMAIN_NAME_API=api.${{ vars.MAIN_DOMAIN }}
            DOMAIN_NAME_N8N=n8n.${{ vars.MAIN_DOMAIN }}
            FRONTEND_URL=https://${{ vars.MAIN_DOMAIN }}
            N8N_URL=https://n8n.${{ vars.MAIN_DOMAIN }}
            BETTER_AUTH_URL=https://api.${{ vars.MAIN_DOMAIN }}

            # Secrets
            INTERNAL_API_SECRET=${{ secrets.INTERNAL_API_SECRET }}
            N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}

            # Redis (Local au projet)
            REDIS_HOST=redis
            REDIS_PORT=6379
            EOF
            chmod 600 .env

            # --- START ---
            echo "üì• Pull & Start..."
            docker compose pull
            docker compose up -d --remove-orphans

            # --- SEEDS (Premier d√©ploiement uniquement) ---
            # On v√©rifie si la table user n8n est vide sur la DB centralis√©e
            echo "üíâ V√©rification Seed N8N..."

            # On utilise le conteneur API (qui a le client pg et les droits) pour checker/seeder
            # Ou on utilise docker run psql temporaire. Utilisons le conteneur n8n lui-m√™me c'est plus simple.
            # Attends, n8n n'a pas psql. Utilisons l'image postgres alpine temporaire connect√©e au r√©seau.

            docker run --rm --network web_network \
              -v $(pwd)/apps/automation/seed/init-n8n.sql:/tmp/init-n8n.sql \
              -e PGPASSWORD=${{ secrets.DB_PASSWORD }} \
              postgres:16-alpine \
              bash -c "
                # Test si la table existe
                if ! psql -h postgres-central -U $DB_USER -d $PROJECT_DB_N8N -c 'SELECT 1 FROM \"user\" LIMIT 1;' > /dev/null 2>&1; then
                   echo 'üì≠ Base n8n vide. Injection du Seed...'
                   psql -h postgres-central -U $DB_USER -d $PROJECT_DB_N8N -f /tmp/init-n8n.sql
                else
                   echo '‚úÖ Base n8n d√©j√† initialis√©e.'
                fi
              "

            # --- MIGRATIONS APP ---
            echo "üì¶ Migrations API..."
            docker compose run --rm api npm run db:migrate

            # --- IMPORT WORKFLOWS ---
            echo "üì• Import N8N Workflows..."
            # On attend un peu que n8n soit up
            sleep 15

            WORKFLOWS_DIR="apps/automation/workflows"

            # Import credentials
            if [ -f "$WORKFLOWS_DIR/credentials.json" ]; then
              docker compose cp "$WORKFLOWS_DIR/credentials.json" n8n:/tmp/credentials.json
              docker compose exec -u node -T n8n n8n import:credentials --input=/tmp/credentials.json || echo "‚ö†Ô∏è Credentials import failed"
            fi

            # Import workflows
            for file in "$WORKFLOWS_DIR"/*.json; do
              filename=$(basename "$file")
              if [ "$filename" != "credentials.json" ]; then
                docker compose cp "$file" n8n:/tmp/workflow.json
                docker compose exec -u node -T n8n n8n import:workflow --input=/tmp/workflow.json || echo "‚ö†Ô∏è Workflow $filename import failed"
              fi
            done

            # Activation & Restart
            docker compose exec -u node -T n8n n8n update:workflow --all --active=true
            docker compose restart n8n

            echo "‚úÖ D√©ploiement termin√© !"
