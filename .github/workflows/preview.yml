name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # --- JOB 1 : BUILD IMAGES (PARALL√àLE) ---
  build-images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api, web]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Lowercase Repo Name
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      # Calcul des URLs pour le frontend (Vite needs it at build time)
      - name: Calculate URLs
        id: urls
        run: echo "API_URL=https://api-pr-${{ github.event.number }}.${{ vars.MAIN_DOMAIN }}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Injection de l'URL API dans le build Web
      - name: Create Web Env
        if: matrix.service == 'web'
        run: echo "VITE_API_URL=${{ steps.urls.outputs.API_URL }}" > ./apps/web/.env

      - name: Build and Push ${{ matrix.service }}
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./apps/${{ matrix.service }}/Dockerfile
          push: true
          # Tag sp√©cifique √† la PR (ex: api:pr-12)
          tags: ghcr.io/${{ env.REPO_LOWER }}/${{ matrix.service }}:pr-${{ github.event.number }}
          cache-from: type=gha,scope=${{ matrix.service }}-pr
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-pr

  # --- JOB 2 : BUILD N8N CUSTOM NODE ---
  build-n8n-node:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: "npm"
          cache-dependency-path: apps/automation/custom-node/package-lock.json
      - name: Build
        run: |
          cd apps/automation/custom-node
          npm ci
          npm run build
          rm -rf node_modules
          npm ci --omit=dev
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: n8n-custom-node
          path: apps/automation/custom-node/
          retention-days: 1

  # --- JOB 3 : D√âPLOIEMENT ---
  deploy-preview:
    needs: [build-images, build-n8n-node]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Lowercase Repo Name
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Calculate Config
        id: config
        run: |
          echo "PR_ID=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "FOLDER_NAME=${{ vars.PROJECT_NAME }}-pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "WEB_URL=https://pr-${{ github.event.number }}.${{ vars.MAIN_DOMAIN }}" >> $GITHUB_OUTPUT
          echo "API_URL=https://api-pr-${{ github.event.number }}.${{ vars.MAIN_DOMAIN }}" >> $GITHUB_OUTPUT
          echo "N8N_URL=https://n8n-pr-${{ github.event.number }}.${{ vars.MAIN_DOMAIN }}" >> $GITHUB_OUTPUT

      # R√©cup√©ration de l'artefact N8N
      - name: Download Custom Node
        uses: actions/download-artifact@v4
        with:
          name: n8n-custom-node
          path: apps/automation/custom-node

      # Nettoyage dossier distant
      - name: Clean Remote Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            FOLDER="${{ steps.config.outputs.FOLDER_NAME }}"
            mkdir -p apps/$FOLDER
            cd apps/$FOLDER
            # Nettoyage propre via docker alpine
            docker run --rm -v "$(pwd):/clean" alpine rm -rf /clean/apps/automation

      # Transfert fichiers
      - name: Copy Config to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml,apps/automation/"
          target: "apps/${{ steps.config.outputs.FOLDER_NAME }}"

      # SSH D√©ploiement
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DB_PASSWORD
          script: |
            export DB_PASSWORD=$DB_PASSWORD
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # --- VARIABLES ---
            PR_TAG="${{ steps.config.outputs.PR_ID }}"
            FOLDER="${{ steps.config.outputs.FOLDER_NAME }}"

            # Noms de DB uniques par PR
            # ex: gen_ai_starter_kit_pr_12_app
            # On remplace les tirets par des underscores pour √™tre SQL compliant
            SAFE_PR_ID=$(echo "$PR_TAG" | tr '-' '_')
            SAFE_PROJECT_NAME=$(echo "${{ vars.PROJECT_NAME }}" | tr '-' '_')

            PROJECT_DB_APP="${SAFE_PROJECT_NAME}_${SAFE_PR_ID}_app"
            PROJECT_DB_N8N="${SAFE_PROJECT_NAME}_${SAFE_PR_ID}_n8n"

            # URL de connexion
            export DATABASE_URL="postgresql://admin_postgres:$DB_PASSWORD@postgres-central:5432/$PROJECT_DB_APP?schema=public"

            cd ~/apps/$FOLDER

            # --- A. PROVISIONING DB (CENTRAL) ---
            echo "üêò Provisioning Database for PR..."
            docker run --rm --network web_network \
              -e PGPASSWORD=${{ secrets.CENTRAL_DB_PASSWORD }} \
              postgres:16-alpine \
              sh -c "
                createdb -h postgres-central -U admin_postgres $PROJECT_DB_APP || true
                createdb -h postgres-central -U admin_postgres $PROJECT_DB_N8N || true
              "

            # --- B. ENV ---
            echo "üîß G√©n√©ration .env..."
            REPO_LOWER="${{ env.REPO_LOWER }}"

            cat <<EOF > .env
            # Images tagg√©es par PR
            IMAGE_NAME_API=ghcr.io/$REPO_LOWER/api:$PR_TAG
            IMAGE_NAME_WEB=ghcr.io/$REPO_LOWER/web:$PR_TAG
            IMAGE_NAME_N8N=n8nio/n8n:latest 

            # Config DB PR
            POSTGRES_USER=admin_postgres
            DB_PASSWORD=$DB_PASSWORD
            POSTGRES_DB_APP=$PROJECT_DB_APP
            POSTGRES_DB_N8N=$PROJECT_DB_N8N

            # Config App PR
            PROJECT_NAME=$FOLDER
            NODE_ENV=production
            PORT=3000

            # URLs PR
            DOMAIN_NAME_WEB=${{ steps.config.outputs.PR_ID }}.${{ vars.MAIN_DOMAIN }}
            DOMAIN_NAME_API=api-${{ steps.config.outputs.PR_ID }}.${{ vars.MAIN_DOMAIN }}
            DOMAIN_NAME_N8N=n8n-${{ steps.config.outputs.PR_ID }}.${{ vars.MAIN_DOMAIN }}

            FRONTEND_URL=${{ steps.config.outputs.WEB_URL }}
            N8N_URL=${{ steps.config.outputs.N8N_URL }}
            BETTER_AUTH_URL=${{ steps.config.outputs.API_URL }}
            DATABASE_URL=$DATABASE_URL

            # Secrets
            INTERNAL_API_SECRET=${{ secrets.INTERNAL_API_SECRET }}
            N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
            REDIS_HOST=redis
            REDIS_PORT=6379
            EOF
            chmod 600 .env

            # --- C. START ---
            echo "üöÄ Start Project $FOLDER..."

            # Important : Le nom du projet (-p) permet d'isoler les conteneurs de cette PR
            docker compose -p $FOLDER pull
            docker compose -p $FOLDER up -d --remove-orphans

            # --- D. N8N DEPS ---
            echo "üì¶ Installation d√©pendances N8N..."
            docker run --rm \
              -v $(pwd)/apps/automation/custom-node:/app \
              -w /app \
              node:22-alpine \
              npm ci --omit=dev

            # Fix permissions
            docker run --rm -v $(pwd)/apps/automation/custom-node:/app alpine chown -R 1000:1000 /app

            # Restart N8N pour charger les deps
            docker compose -p $FOLDER restart n8n

            # --- E. POST-DEPLOY ---
            echo "üì¶ Migrations API..."
            docker compose -p $FOLDER run --rm -e DATABASE_URL=$DATABASE_URL api npm run db:migrate

            echo "üå± Seed API..."
            docker compose -p $FOLDER run --rm -e DATABASE_URL=$DATABASE_URL api npm run db:seed

            echo "üì• Import N8N Workflows..."
            WORKFLOWS_DIR="apps/automation/workflows"

            # Attente N8N ready (Healthcheck) pour √©viter race condition
            docker run --rm --network web_network curlimages/curl:latest \
              sh -c 'until curl -s -f http://'$FOLDER'-n8n-1:5678/healthz > /dev/null; do sleep 3; done'

            if [ -f "$WORKFLOWS_DIR/credentials.json" ]; then
              docker compose -p $FOLDER cp "$WORKFLOWS_DIR/credentials.json" n8n:/tmp/credentials.json
              docker compose -p $FOLDER exec -u node -T n8n n8n import:credentials --input=/tmp/credentials.json || true
            fi

            for file in "$WORKFLOWS_DIR"/*.json; do
              filename=$(basename "$file")
              if [ "$filename" != "credentials.json" ]; then
                docker compose -p $FOLDER cp "$file" n8n:/tmp/workflow.json
                docker compose -p $FOLDER exec -u node -T n8n n8n import:workflow --input=/tmp/workflow.json || true
              fi
            done

            docker compose -p $FOLDER exec -u node -T n8n n8n update:workflow --all --active=true

            # On ne red√©marre pas N8N ici, les workflows sont actifs √† chaud ou au prochain trigger

            echo "‚úÖ Preview D√©ploy√©e !"

      - name: Comment PR URL
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            üöÄ **Preview Environment Ready!**

            üé® **Frontend:** ${{ steps.config.outputs.WEB_URL }}
            ‚öôÔ∏è **API:** ${{ steps.config.outputs.API_URL }}
            ü§ñ **n8n:** ${{ steps.config.outputs.N8N_URL }}
          comment_tag: execution
