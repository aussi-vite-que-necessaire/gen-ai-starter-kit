name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

env:
  PROJECT_NAME: "gen-ai-starter-kit"

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            PR_ID="pr-${{ github.event.number }}"
            # Le nom du dossier sera bien "gen-ai-starter-kit-pr-XX"
            FOLDER_NAME="${{ env.PROJECT_NAME }}-$PR_ID"

            TARGET_DIR="$HOME/apps/$FOLDER_NAME"

            if [ -d "$TARGET_DIR" ]; then
              cd "$TARGET_DIR"
              
              echo "üóë  Arr√™t des services (API, Web, DB, Redis)..."
              # Le down va supprimer api, web, db, redis gr√¢ce au docker-compose.yml pr√©sent
              docker compose -p $FOLDER_NAME down --volumes --remove-orphans
              
              echo "üóë  Suppression du dossier..."
              cd ..
              rm -rf "$TARGET_DIR"
              
              echo "‚úÖ Environnement $FOLDER_NAME supprim√© avec succ√®s."
            else
              echo "‚ö†Ô∏è Le dossier $TARGET_DIR n'existe pas (ou a d√©j√† √©t√© supprim√©)."
            fi
