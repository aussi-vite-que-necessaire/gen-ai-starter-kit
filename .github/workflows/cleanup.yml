name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            PR_ID="pr-${{ github.event.number }}"
            # On utilise la variable PROJECT_NAME
            FOLDER_NAME="${{ vars.PROJECT_NAME }}-$PR_ID"

            TARGET_DIR="$HOME/apps/$FOLDER_NAME"

            if [ -d "$TARGET_DIR" ]; then
              cd "$TARGET_DIR"
              echo "ðŸ—‘  ArrÃªt des services..."
              docker compose -p $FOLDER_NAME down --volumes --remove-orphans
              
              cd ..
              echo "ðŸ—‘  Suppression du dossier..."
              rm -rf "$TARGET_DIR"
              echo "âœ… Cleaned up $FOLDER_NAME"
            fi
