name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            PR_ID="pr-${{ github.event.number }}"
            # On doit recalculer le nom unique ici aussi
            FOLDER_NAME="${{ vars.PROJECT_NAME }}-$PR_ID"
            TARGET_DIR="$HOME/apps/$FOLDER_NAME"

            if [ -d "$TARGET_DIR" ]; then
              cd "$TARGET_DIR"
              echo "üõë Arr√™t des services pour $FOLDER_NAME..."
              # Supprime les conteneurs et les volumes SP√âCIFIQUES √† cette PR
              docker compose -p $FOLDER_NAME down --volumes --remove-orphans
              
              cd ..
              echo "üóë Suppression du dossier..."
              rm -rf "$TARGET_DIR"
              
              echo "‚ú® Grand Nettoyage du serveur..."
              # Ici on peut y aller : on supprime toutes les images qui ne servent plus
              # (Notamment celles de la PR qu'on vient de tuer)
              docker system prune -a -f
              
              echo "‚úÖ Cleaned up $FOLDER_NAME successfully"
            else
              echo "‚ö†Ô∏è Dossier $TARGET_DIR introuvable, rien √† faire."
            fi
